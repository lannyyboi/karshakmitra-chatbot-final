<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarshakMitra</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font for a clean, professional look -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- Poppins for the heading -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #dff0d8;
            background-image: repeating-linear-gradient(
                -45deg,
                #e6f2e6 0,
                #e6f2e6 1px,
                #dff0d8 0,
                #dff0d8 50%
            );
            background-size: 10px 10px;
        }
        .chat-container {
            height: 100vh;
        }
        .chat-box {
            height: calc(100% - 6rem);
            overflow-y: auto;
            /* Hide scrollbar for a cleaner look */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .chat-box::-webkit-scrollbar {
            display: none;
        }
        .message {
            max-width: 80%;
            cursor: pointer;
        }
        .user-message {
            align-self: flex-end;
        }
        .ai-message {
            align-self: flex-start;
        }
        .copy-button {
            display: none;
        }
        /* Show the copy button on hover */
        .message:hover .copy-button {
            display: block;
        }
        .heading-font {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>
<body class="flex items-center justify-center p-0">

    <div class="w-full h-screen flex flex-col border border-green-400 rounded-lg shadow-xl">
        <!-- Header -->
        <div class="p-4 bg-white text-green-800 shadow-md flex items-center justify-center space-x-2">
            <!-- Hand-drawn leaf icon from a public domain source (example) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-green-700">
                <path d="M12 22a8 8 0 0 0 8 -8c0 -1.6 -0.5 -3.2 -1.4 -4.6l-5.6 -9.4a1 1 0 0 0 -1.7 0l-5.6 9.4a8 8 0 0 0 -1.4 4.6c0 4.4 3.6 8 8 8z" />
                <path d="M12 22a8 8 0 0 0 0 -16a8 8 0 0 0 0 16z" />
            </svg>
            <h1 class="text-xl font-bold heading-font">KarshakMitra</h1>
        </div>

        <!-- Chat Box to display messages -->
        <div id="chat-box" class="flex-1 p-4 flex flex-col space-y-4 chat-box">
            <!-- Initial AI message to greet the user -->
            <div id="initial-message" class="bg-green-100 text-green-800 p-3 rounded-xl self-start message ai-message shadow-sm">
                <p>Hello! I am an AI chat assistant. You can ask me anything.</p>
            </div>
        </div>

        <!-- Typing Indicator and Input Field -->
        <div class="p-4 bg-white shadow-inner">
            <div id="typing-indicator" class="hidden text-gray-500 mb-2">
                Typing...
            </div>
            <div class="flex items-center space-x-2">
                <input id="user-input" type="text" placeholder="Type or speak your message here..." class="flex-1 p-3 rounded-full border border-green-400 focus:outline-none focus:ring-2 focus:ring-green-600 transition-all duration-200">
                
                <!-- Microphone button for voice input -->
                <button id="mic-button" class="bg-green-600 text-white p-3 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a4 4 0 110-8 4 4 0 010 8z" />
                    </svg>
                </button>
                
                <!-- Send button for text input -->
                <button id="send-button" class="bg-green-600 text-white p-3 rounded-full shadow-lg hover:bg-green-700 transition-colors duration-200 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">Click on any message to see its translation.</p>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const micButton = document.getElementById('mic-button');
        const typingIndicator = document.getElementById('typing-indicator');

        const apiKey = "AIzaSyCS8Q_bCDdEr0eGTwWTF9F5T2jYNmrMtRQ";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        let chatHistory = [];

        const initialMessages = {
            'en': 'Hello! I am an AI chat assistant. You can ask me anything.',
            'ml': 'നമസ്കാരം! ഞാൻ ഒരു AI ചാറ്റ് അസിസ്റ്റന്റാണ്. നിങ്ങൾക്ക് എന്നോട് എന്തും ചോദിക്കാവുന്നതാണ്.'
        };
        
        let recognition;

        const translateText = async (text, targetLang) => {
            const translationPayload = {
                contents: [{
                    parts: [{
                        text: `Translate the following text to ${targetLang === 'ml' ? 'Malayalam' : 'English'}: ${text}`
                    }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(translationPayload)
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Error translating text:', error);
                return `Translation failed. Error: ${error.message}`;
            }
        };

        const addMessage = async (text, isUser) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'p-3', 'rounded-xl', 'shadow-sm', 'relative');
            messageElement.style.whiteSpace = 'pre-wrap';
            
            const messageContent = document.createElement('p');
            messageContent.textContent = text;
            messageElement.appendChild(messageContent);
            
            let originalText = text;
            let translatedText = '';

            const lang = detectLanguage(text);
            if (lang === 'en') {
                translatedText = await translateText(text, 'ml');
            } else {
                translatedText = await translateText(text, 'en');
            }

            messageElement.setAttribute('data-original-text', originalText);
            messageElement.setAttribute('data-translated-text', translatedText);

            const copyButton = document.createElement('button');
            copyButton.classList.add('copy-button', 'absolute', 'top-1', 'right-1', 'p-1', 'bg-gray-200', 'rounded-full', 'hover:bg-gray-300', 'transition-all', 'duration-200');
            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
            copyButton.title = "Copy to clipboard";
            copyButton.onclick = () => {
                const textToCopy = messageContent.textContent;
                const tempInput = document.createElement('textarea');
                tempInput.value = textToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert("Message copied!");
            };
            messageElement.appendChild(copyButton);

            messageElement.addEventListener('click', () => {
                const currentText = messageContent.textContent;
                const original = messageElement.getAttribute('data-original-text');
                const translated = messageElement.getAttribute('data-translated-text');

                if (currentText === original) {
                    messageContent.textContent = translated;
                } else {
                    messageContent.textContent = original;
                }
            });

            if (isUser) {
                messageElement.classList.add('bg-green-300', 'text-green-900', 'user-message');
            } else {
                messageElement.classList.add('bg-green-100', 'text-green-800', 'ai-message');
            }
            
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;

            // This is the correct place to add the message to history.
            chatHistory.push({
                role: isUser ? "user" : "model",
                parts: [{ text: originalText }]
            });
        };
        
        const detectLanguage = (text) => {
            const malayalamChars = /[\u0D00-\u0D7F]/;
            if (malayalamChars.test(text)) {
                return 'ml';
            }
            return 'en';
        };

        const sendMessage = async () => {
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            addMessage(userMessage, true);
            userInput.value = '';

            typingIndicator.classList.remove('hidden');

            const systemInstruction = {
                parts: [{
                    text: `You are an AI assistant named KarshakMitra. Your primary function is to provide expert advice on farming, specifically for crops common in Kerala, India. If a user asks about a specific crop (e.g., 'tomato', 'coconut', 'rice'), provide detailed information on optimal farming conditions including soil type, climate, seed types, pests, diseases, and harvesting. If the user's query is not related to farming, respond in a friendly, conversational tone and redirect them to farming-related topics. Respond in the same language as the user. If the user's language is ambiguous, respond in English.`
                }]
            };

            const payload = {
                contents: chatHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: systemInstruction
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                addMessage(aiResponse, false);
            } catch (error) {
                console.error('Error fetching from API:', error);
                addMessage('Sorry, an error occurred while trying to get a response.', false);
            } finally {
                typingIndicator.classList.add('hidden');
            }
        };
        
        // Voice recognition logic
        micButton.addEventListener('click', () => {
            if (recognition && recognition.isListening) {
                recognition.stop();
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('Speech recognition is not supported in this browser. Please use Google Chrome.');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.interimResults = false;
            recognition.lang = 'en-US,ml-IN';
            
            recognition.start();
            micButton.classList.remove('bg-green-600');
            micButton.classList.add('bg-red-600');
            userInput.placeholder = "Listening...";
            
            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');
                
                userInput.value = transcript;
            };

            recognition.onend = () => {
                micButton.classList.remove('bg-red-600');
                micButton.classList.add('bg-green-600');
                userInput.placeholder = "Type or speak your message here...";
                if (userInput.value.trim() !== '') {
                    sendMessage();
                }
            };
        });

        // Event listeners for sending a message with the button or the Enter key
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Show initial AI message
        window.addEventListener('DOMContentLoaded', () => {
            addMessage(initialMessages['en'], false);
        });
    </script>
</body>
</html>
